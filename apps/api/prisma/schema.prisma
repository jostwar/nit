generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  ANALYST
}

enum AlertRuleType {
  NO_PURCHASE_DAYS
  DROP_PERCENT
  BRAND_LOST
  DSO_HIGH
}

enum AlertStatus {
  OPEN
  CLOSED
}

model Tenant {
  id          String    @id @default(cuid())
  name        String
  lastSyncAt  DateTime?
  createdAt   DateTime  @default(now())

  users         User[]
  customers     Customer[]
  invoices      Invoice[]
  invoiceItems InvoiceItem[]
  productClasses ProductClass[]
  productBrands  ProductBrand[]
  inventoryDirectories InventoryDirectory[]
  payments       Payment[]
  credits       Credit[]
  metrics       MetricsDaily[]
  alertRules    AlertRule[]
  alertEvents   AlertEvent[]
}

model User {
  id           String   @id @default(cuid())
  tenantId     String
  email        String   @unique
  passwordHash String
  role         Role
  createdAt    DateTime @default(now())

  tenant        Tenant        @relation(fields: [tenantId], references: [id])
  refreshTokens RefreshToken[]
}

model RefreshToken {
  id         String   @id @default(cuid())
  userId     String
  tokenHash  String
  expiresAt  DateTime
  revokedAt  DateTime?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Customer {
  id        String   @id @default(cuid())
  tenantId  String
  nit       String
  name      String
  segment   String?
  city      String?
  vendor    String?
  createdAt DateTime @default(now())

  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  invoices Invoice[]
  payments Payment[]
  credit   Credit?
  metrics  MetricsDaily[]
  alertEvents AlertEvent[]

  @@index([tenantId])
  @@unique([tenantId, nit])
}

model Invoice {
  id            String   @id @default(cuid())
  tenantId      String
  customerId    String
  invoiceNumber String
  issuedAt      DateTime
  total         Decimal  @db.Decimal(14, 2)
  margin        Decimal  @db.Decimal(14, 2)
  units         Int
  vendor        String?  // NOMVEN de GenerarInfoVentas
  city          String?  // ciudad/sector de la venta (NOMSEC, nomciu, etc.) para filtros
  // TIPOMOV: tipo documento (ej. 01, 13=SUMA; 04, 06, 15=RESTA). Ventas netas = sum(signedTotal)
  documentType  String?  // código TIPOMOV
  saleSign      Int      @default(1) // 1=SUMA VENTA, -1=RESTA VENTA
  signedTotal   Decimal  @db.Decimal(14, 2) // total * saleSign para agregaciones
  signedMargin  Decimal  @db.Decimal(14, 2)
  signedUnits   Int // units * saleSign

  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])
  items    InvoiceItem[]
  payments Payment[]

  @@index([tenantId])
  @@index([customerId])
  @@index([tenantId, issuedAt])
}

model InvoiceItem {
  id          String   @id @default(cuid())
  tenantId    String
  invoiceId   String
  productName String
  brand       String   // nombre de marca (mapeado por ref→CSV/inventario + brandCodeToName)
  category    String
  classCode   String?  // código CLASE (para filtros)
  className   String?  // nombre de clase (mapeado por ref→CSV/inventario + ProductClass)
  quantity    Int
  unitPrice   Decimal  @db.Decimal(14, 2)
  total       Decimal  @db.Decimal(14, 2)
  margin      Decimal  @db.Decimal(14, 2)

  tenant  Tenant  @relation(fields: [tenantId], references: [id])
  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@index([tenantId])
  @@index([invoiceId])
}

model ProductClass {
  id       String @id @default(cuid())
  tenantId String
  code     String
  name     String

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, code])
  @@index([tenantId])
}

model ProductBrand {
  id       String @id @default(cuid())
  tenantId String
  code     String
  name     String

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, code])
  @@index([tenantId])
}

/// Directorio de inventario: REFER (referencia) → MARCA y CLASE. Cruce con ítems de GenerarInfoVentas.
model InventoryDirectory {
  id        String  @id @default(cuid())
  tenantId  String
  reference String  /// Referencia del producto (REFER); se normaliza mayúsculas para cruce
  brand     String  /// MARCA
  classCode String  /// CLASE (código)

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, reference])
  @@index([tenantId])
}

model Payment {
  id         String   @id @default(cuid())
  tenantId   String
  customerId String
  invoiceId  String?
  paidAt     DateTime
  amount     Decimal  @db.Decimal(14, 2)

  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])
  invoice  Invoice? @relation(fields: [invoiceId], references: [id])

  @@index([tenantId])
  @@index([customerId])
}

model Credit {
  id         String   @id @default(cuid())
  tenantId   String
  customerId String   @unique
  creditLimit Decimal @db.Decimal(14, 2)
  balance     Decimal @db.Decimal(14, 2)
  overdue     Decimal @db.Decimal(14, 2)
  dsoDays     Int

  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])

  @@index([tenantId])
}

model MetricsDaily {
  id            String   @id @default(cuid())
  tenantId      String
  customerId    String
  date          DateTime
  totalSales    Decimal  @db.Decimal(14, 2)
  totalInvoices Int
  totalUnits    Int
  totalMargin   Decimal  @db.Decimal(14, 2)
  avgTicket     Decimal  @db.Decimal(14, 2)
  lastPurchaseAt DateTime?

  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])

  @@index([tenantId])
  @@index([customerId, date])
  @@unique([tenantId, customerId, date])
}

model AlertRule {
  id        String        @id @default(cuid())
  tenantId  String
  name      String
  type      AlertRuleType
  params    Json
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
  events AlertEvent[]

  @@index([tenantId])
}

model AlertEvent {
  id         String      @id @default(cuid())
  tenantId   String
  customerId String
  ruleId     String
  status     AlertStatus @default(OPEN)
  message    String
  createdAt  DateTime    @default(now())

  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  customer Customer  @relation(fields: [customerId], references: [id])
  rule     AlertRule @relation(fields: [ruleId], references: [id])

  @@index([tenantId])
  @@index([customerId])
  @@index([ruleId])
}
